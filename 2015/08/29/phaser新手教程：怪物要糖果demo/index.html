<!-- build time:Fri Jun 15 2018 10:43:40 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="TIRp90R4UV"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css"><meta name="keywords" content="phaser 怪物要糖果demo,phaser教程,"><link rel="shortcut icon" type="image/x-icon" href="/uploads/favicon.ico?v=5.1.2"><meta name="description" content="在这个特别长的教程里，我将详细解释“怪物要糖果”的代码。这是一个多平台游戏，使用Phaser（HTML5游戏引擎）制作。这样你就可以了解Phaser，并将学到的技巧用来创建你自己的HTML5游戏。说明如果你想制作HTML5游戏，最好选择一个框架或引擎。你可以用JavaScript写游戏，但使用一个框架，会大大提高开发效率。Phaser是一个新的HTML5游戏开发框架，如果你第一次听说它，那一定要试"><meta name="keywords" content="phaser 怪物要糖果demo,phaser教程"><meta property="og:type" content="article"><meta property="og:title" content="Phaser新手教程：开发”怪物要糖果“游戏"><meta property="og:url" content="http://www.grycheng.com/2015/08/29/phaser新手教程：怪物要糖果demo/index.html"><meta property="og:site_name" content="BaoSheng"><meta property="og:description" content="在这个特别长的教程里，我将详细解释“怪物要糖果”的代码。这是一个多平台游戏，使用Phaser（HTML5游戏引擎）制作。这样你就可以了解Phaser，并将学到的技巧用来创建你自己的HTML5游戏。说明如果你想制作HTML5游戏，最好选择一个框架或引擎。你可以用JavaScript写游戏，但使用一个框架，会大大提高开发效率。Phaser是一个新的HTML5游戏开发框架，如果你第一次听说它，那一定要试"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://www.npm8.com/wp-content/uploads/2015/08/eee-650x476.png"><meta property="og:image" content="http://www.npm8.com/wp-content/uploads/2015/08/monster-demo-screens.jpg"><meta property="og:image" content="http://www.npm8.com/wp-content/uploads/2015/08/15.png"><meta property="og:image" content="http://www.npm8.com/wp-content/uploads/2015/08/24.png"><meta property="og:image" content="http://www.npm8.com/wp-content/uploads/2015/08/34.png"><meta property="og:image" content="http://www.npm8.com/wp-content/uploads/2015/08/button-start-150x150.png"><meta property="og:image" content="http://www.npm8.com/wp-content/uploads/2015/08/11.jpg"><meta property="og:updated_time" content="2018-06-14T07:47:52.356Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Phaser新手教程：开发”怪物要糖果“游戏"><meta name="twitter:description" content="在这个特别长的教程里，我将详细解释“怪物要糖果”的代码。这是一个多平台游戏，使用Phaser（HTML5游戏引擎）制作。这样你就可以了解Phaser，并将学到的技巧用来创建你自己的HTML5游戏。说明如果你想制作HTML5游戏，最好选择一个框架或引擎。你可以用JavaScript写游戏，但使用一个框架，会大大提高开发效率。Phaser是一个新的HTML5游戏开发框架，如果你第一次听说它，那一定要试"><meta name="twitter:image" content="http://www.npm8.com/wp-content/uploads/2015/08/eee-650x476.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",sidebar:{position:"left",display:"post",offset:12,offset_float:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.grycheng.com/2015/08/29/phaser新手教程：怪物要糖果demo/"><title>Phaser新手教程：开发”怪物要糖果“游戏 | BaoSheng</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?‘6c005185d8aabb2ec10cf577df122aa7’";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">BaoSheng</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Rome was not built in a day.</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.grycheng.com/2015/08/29/phaser新手教程：怪物要糖果demo/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="baosheng"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="BaoSheng"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Phaser新手教程：开发”怪物要糖果“游戏</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-08-29T22:41:45+08:00">2015-08-29 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Phaser/" itemprop="url" rel="index"><span itemprop="name">Phaser</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>在这个特别长的教程里，我将详细解释“怪物要糖果”的代码。这是一个多平台游戏，使用Phaser（HTML5游戏引擎）制作。这样你就可以了解Phaser，并将学到的技巧用来创建你自己的HTML5游戏。</p><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a><strong>说明</strong></h3><p>如果你想制作HTML5游戏，最好选择一个框架或引擎。你可以用JavaScript写游戏，但使用一个框架，会大大提高开发效率。</p><p>Phaser是一个新的HTML5游戏开发框架，如果你第一次听说它，那一定要试一试。</p><h3 id="Phaser是什么？"><a href="#Phaser是什么？" class="headerlink" title="Phaser是什么？"></a><strong>Phaser是什么？</strong></h3><p>Phaser是由Photon Storm开发的HTML5游戏框架。该框架用纯JavaScript编写，但也包含TypeScript定义文件 。</p><p>Phaser 是基于Flash游戏开发平台 Flixel编写的，所以Flash开发者会感到很熟悉。它使用pixi.js 引擎在屏幕上用Canvas或WebGL渲染。</p><p><img src="http://www.npm8.com/wp-content/uploads/2015/08/eee-650x476.png" alt=""></p><p>这是相当新的引擎，在活跃社区<a href="http://www.html5gamedevs.com/forum/14-phaser/" target="_blank" rel="external">html5gamedevs</a>的帮助下增长迅速。已经有 <a href="http://www.lessmilk.com/phaser-tutorial/" target="_blank" rel="external">很多的教程和文章</a> 可以找到，你也可以查阅 <a href="http://docs.phaser.io/" target="_blank" rel="external">官方文档</a> ，里面收集了大量的 <a href="http://examples.phaser.io/" target="_blank" rel="external">开发实例</a> ，是非常有用的。Phaser是<a href="https://github.com/photonstorm/phaser" target="_blank" rel="external">开源</a>的，你可以直接深入了解并学习它的源代码。</p><p>Phaser 最新的稳定版，是2.0. 7。</p><h3 id="什么是怪物要糖果？"><a href="#什么是怪物要糖果？" class="headerlink" title="什么是怪物要糖果？"></a><strong>什么是怪物要糖果？</strong></h3><p>当我开始制作游戏，首先确定核心玩法，并尝试迅速建立了一个<a href="http://candy-demo.enclavegames.com/" target="_blank" rel="external">游戏原型</a>。在这个案例中，我们从一个相当简单的演示 发展出来的游戏名字叫 <a href="http://enclavegames.com/games/monster-wants-candy/" target="_blank" rel="external">怪物要糖果</a> 。 首先我会告诉你项目的结构，所以你可以理解整个游戏玩法。我们将根据游戏运行的逻辑顺序来讲解：装载图片资源，创建主菜单，实际的游戏循环。你可以<a href="http://candy-demo.enclavegames.com/" target="_blank" rel="external">试玩怪物要糖果</a>。</p><p><a href="http://www.npm8.com/wp-content/uploads/2015/08/monster-demo-screens.jpg" target="_blank" rel="external"><img src="http://www.npm8.com/wp-content/uploads/2015/08/monster-demo-screens.jpg" alt="monster-demo-screens"></a></p><p>怪物要糖果的故事很简单：邪恶的国王绑架了你的爱人，你必须收集足够多的糖果才能让她回来。玩法很简单：糖果掉落下来，你可以点击吃掉它们。你吃糖果越多，积分就越高，就会有更好的糖果被解锁。如果你让糖果掉出来屏幕，就会减少生命，然后游戏就结束了。</p><p>正如你所看到的，这是一个非常简单但结构完整的游戏。你会发现框架的最重要的用途是，载入图像，绘制精灵以及检测用户活动。这是一个很好的开始，你可以复制代码，研究它们，制作你自己的游戏。</p><h3 id="项目设置及结构"><a href="#项目设置及结构" class="headerlink" title="项目设置及结构"></a><strong>项目设置及结构</strong></h3><p>你可以阅读框架作者写的“<a href="http://gamedevelopment.tutsplus.com/articles/how-to-learn-the-phaser-html5-game-engine--gamedev-13643" target="_blank" rel="external">如何开始使用Phaser</a>” ，或者可以从<a href="https://github.com/photonstorm/phaser/blob/master/build/phaser.min.js" target="_blank" rel="external">GitHub</a>复制 phaser.min.js 文件到你的项目目录。不需要IDE，点击 index.html就可以在浏览器 文件立即看到源代码所做的更改。</p><p>我们的项目目录中包含 index.html 文件（包括HTML5结构和所有必要的JS文件）。还有两个子目录：</p><p>IMG目录，里面是美术资源，SRC目录，里面是游戏的源代码。</p><p>这里是目录结构预览：</p><p><a href="http://www.npm8.com/wp-content/uploads/2015/08/15.png" target="_blank" rel="external"><img src="http://www.npm8.com/wp-content/uploads/2015/08/15.png" alt="1"></a></p><p>在 SRC 目录，你会看到JavaScript文件。在本教程中，我将描述在该文件夹中的所有文件的内容和用途。 你可以看到每个文件的<a href="https://github.com/tutsplus/Monster-Wants-Candy-demo" target="_blank" rel="external">源代码</a>。</p><p><strong>index.html</strong></p><p>我们从index.html 文件开始。它看起来像一个HTML5网站，但代替文本和HTML元素是Phaser框架渲染的Canvas元素。<br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Monster Wants Candy demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"> <span class="selector-tag">body</span> &#123; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">background</span>: <span class="number">#B4D9E7</span>; &#125; </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"src/phaser.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"src/Boot.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"src/Preloader.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"src/MainMenu.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"src/Game.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></div><div class="line"><span class="javascript"><span class="keyword">var</span> game = <span class="keyword">new</span> Phaser.Game(<span class="number">640</span>, <span class="number">960</span>, Phaser.AUTO, <span class="string">'game'</span>);</span></div><div class="line"><span class="javascript">game.state.add(<span class="string">'Boot'</span>, Candy.Boot);</span></div><div class="line"><span class="javascript">game.state.add(<span class="string">'Preloader'</span>, Candy.Preloader);</span></div><div class="line"><span class="javascript">game.state.add(<span class="string">'MainMenu'</span>, Candy.MainMenu);</span></div><div class="line"><span class="javascript">game.state.add(<span class="string">'Game'</span>, Candy.Game);</span></div><div class="line"><span class="javascript">game.state.start(<span class="string">'Boot'</span>);</span></div><div class="line"><span class="undefined">&#125;)();</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><p></p><p>我们在<code>&lt;head&gt;</code> 标签定义文档：字符集编码，网页标题以及CSS样式。通常我们会引用外部CSS文件，但在这里不需要，正如我前面提到的，一切都将在一个canvas元素中呈现，所以我们不会有任何的HTML元素。</p><p>要做的最后一件事是：我们所有的JS文件：从 phaser.min.js 文件到所有包含游戏代码的文件。为了减少浏览器的请求数，使游戏的载入速度更快，我们将在游戏需要的时候单独载入它们。</p><p>我们来看<code>&lt;body&gt;</code> 标签，在这里初始化框架并开始我们的游戏。第一行代码调用函数；看起来像这样：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> game = <span class="keyword">new</span> Phaser.Game(<span class="number">640</span>, <span class="number">960</span>, Phaser.AUTO, <span class="string">'game'</span>);</div></pre></td></tr></table></figure><p></p><p>此代码将初始化Phaser：</p><p>640 是游戏的宽度，960 是游戏的高度。</p><p>phaser.auto 通知框架我们希望游戏如何渲染到画布上。这里有三个选项： CANVAS, WEBGL 和 AUTO。第一个将我们的游戏渲染在2D Canvas上；第二个使用WebGL在可能的情况下渲染游戏（现在主要用于桌面游戏，但是移动端支持也会越来越好）；第三个通知框架，自动检查是否支持WebGL，从而决定游戏如何呈现，如果不支持WebGL，那么2D Canvas将被使用。</p><p>该框架初始化将被分配到单个对象称为 game。</p><p>下一行的是关于我们的游戏：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">game.state.add(<span class="string">'Boot'</span>, Candy.Boot);</div></pre></td></tr></table></figure><p></p><p>‘Boot’ 是一个状态名， Candy.Boot 是一个对象（在下面代码中定义），我们开始进入状态时将被执行。我们为Boot 添加状态（配置），Preloader （加载资源），MainMenu （你猜对了；这是游戏主菜单）和Game （游戏主循环）。最后一行， game.state.start(‘Boot’)，启动Boot 状态，Candy.Boot 对象将被执行。</p><p>你可以看到，一个主要的JavaScript游戏对象已被创建。在游戏中，我们有 Boot, Preloader, MainMenu,和 Game 对象，我们使用原型定义它们。有一些特殊功能的对象名被框架本身保留（preload() ，create() ，update()，和 render()），但我们也可以定义自己的（startgame() ，spawncandy() ，managepause()）。如果你不确定你明白这一切，别担心我会使用示例代码解释这一切。</p><h3 id="游戏"><a href="#游戏" class="headerlink" title="游戏"></a><strong>游戏</strong></h3><p>现在让我们忘记 Boot, Preloader和 MainMenu 。他们将在以后详细解释；此刻你要知道的是Boot 状态决定游戏的基本配置， Preloader 将加载所有的美术资源，并 MainMenu 将开始游戏菜单。</p><p>让我们关注游戏本身，看看Game代码。在解释game.js 代码之前，让我们从开发者的角度来谈谈游戏概念本身。</p><h3 id="Portrait-模式"><a href="#Portrait-模式" class="headerlink" title="Portrait 模式"></a><strong>Portrait 模式</strong></h3><p>游戏是竖屏模式。</p><p><img src="http://www.npm8.com/wp-content/uploads/2015/08/24.png" alt="2"></p><p>在这种模式下，屏幕的高度大于其宽度。有的游戏适合竖屏（像怪物要糖果），有的游戏适合横屏（包括平台游戏， 比如<a href="http://enclavegames.com/games/craigen/" target="_blank" rel="external">Craigen</a>），甚至某些类型的游戏在两种模式下都可以运行，通常这样的游戏比较难写。</p><h3 id="Game-js"><a href="#Game-js" class="headerlink" title="Game.js"></a><strong>Game.js</strong></h3><p>在我们开始game.js 文件之前，先看看它的结构。这里有一个为我们创造的世界，有一个玩家角色在里面，它的工作就是吃糖果。</p><p>游戏世界：怪物后面的世界是静态的。背景中有一张糖果大陆的图片，我们可以在前景中看到怪物，还有一个用户界面。</p><p>玩家角色： 这个演示非常简单，所以小怪物除了等待糖果什么也不做。对于玩家，主要任务就是收集糖果。</p><p>糖果：游戏的核心机制是吃尽可能多的糖果。糖果在屏幕的顶部边缘产生，玩家必须在它们掉落的时候点击（或点击）。如果任何糖果掉出屏幕的底部，删除它，玩家将受到伤害。我们还没有生命系统，因此，游戏结束后立即显示适当的消息。</p><p>好吧，现在让我们看看game.js：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Candy.Game = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;;</div><div class="line">Candy.Game.prototype = &#123;</div><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;,</div><div class="line">managePause: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;,</div><div class="line">update: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line">&#125;;</div><div class="line">Candy.item = &#123;</div><div class="line">spawnCandy: <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;,</div><div class="line">clickCandy: <span class="function"><span class="keyword">function</span>(<span class="params">candy</span>) </span>&#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;,</div><div class="line">removeCandy: <span class="function"><span class="keyword">function</span>(<span class="params">candy</span>) </span>&#123;</div><div class="line"><span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p><p>Candy.Game有三个函数：</p><ul><li>· create() 初始化</li><li>· managepause() 暂停和继续游戏</li><li>· update() 管理游戏主循环</li></ul><p>我们将创建一个方便的对象称为 item 代表单一的糖果。它会有一些有用的方法：</p><ul><li>· spawncandy() 增加新糖果</li><li>· clickcandy() 当用户点击时，糖果消失</li><li>· removecandy() 删除糖果</li></ul><p>让我们使用这些代码：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Candy.Game = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>._player = <span class="literal">null</span>;</div><div class="line"><span class="keyword">this</span>._candyGroup = <span class="literal">null</span>;</div><div class="line"><span class="keyword">this</span>._spawnCandyTimer = <span class="number">0</span>;</div><div class="line"><span class="keyword">this</span>._fontStyle = <span class="literal">null</span>;</div><div class="line">Candy._scoreText = <span class="literal">null</span>;</div><div class="line">Candy._score = <span class="number">0</span>;</div><div class="line">Candy._health = <span class="number">0</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p><p>在这里，我们声明所有将使用的变量。<br>通过定义 this._name，我们限制了Candy.Game变量使用的范围。 这意味着他们不能用在其他状态中。</p><p>通过定义Candy._name，我们允许这些变量被对象使用，例如， Candy._score 的数值可以被 Candy.item.clickCandy()函数增加。</p><p>对象初始化为null，需要的变量初始化为零。</p><p>看看candy.game.prototype的代码：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.physics.startSystem(Phaser.Physics.ARCADE);</div><div class="line"><span class="keyword">this</span>.physics.arcade.gravity.y = <span class="number">200</span>;</div><div class="line"></div><div class="line"><span class="keyword">this</span>.add.sprite(<span class="number">0</span>, <span class="number">0</span>, <span class="string">'background'</span>);</div><div class="line"><span class="keyword">this</span>.add.sprite(<span class="number">-30</span>, Candy.GAME_HEIGHT<span class="number">-160</span>, <span class="string">'floor'</span>);</div><div class="line"><span class="keyword">this</span>.add.sprite(<span class="number">10</span>, <span class="number">5</span>, <span class="string">'score-bg'</span>);</div><div class="line"><span class="keyword">this</span>.add.button(Candy.GAME_WIDTH<span class="number">-96</span><span class="number">-10</span>, <span class="number">5</span>, <span class="string">'button-pause'</span>, <span class="keyword">this</span>.managePause, <span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="keyword">this</span>._player = <span class="keyword">this</span>.add.sprite(<span class="number">5</span>, <span class="number">760</span>, <span class="string">'monster-idle'</span>);</div><div class="line"><span class="keyword">this</span>._player.animations.add(<span class="string">'idle'</span>, [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>], <span class="number">10</span>, <span class="literal">true</span>);</div><div class="line"><span class="keyword">this</span>._player.animations.play(<span class="string">'idle'</span>);</div><div class="line"></div><div class="line"><span class="keyword">this</span>._spawnCandyTimer = <span class="number">0</span>;</div><div class="line">Candy._health = <span class="number">10</span>;</div><div class="line"></div><div class="line"><span class="keyword">this</span>._fontStyle = &#123; <span class="attr">font</span>: <span class="string">"40px Arial"</span>, <span class="attr">fill</span>: <span class="string">"#FFCC00"</span>, <span class="attr">stroke</span>: <span class="string">"#333"</span>, <span class="attr">strokeThickness</span>: <span class="number">5</span>, <span class="attr">align</span>: <span class="string">"center"</span> &#125;;</div><div class="line">Candy._scoreText = <span class="keyword">this</span>.add.text(<span class="number">120</span>, <span class="number">20</span>, <span class="string">"0"</span>, <span class="keyword">this</span>._fontStyle);</div><div class="line"></div><div class="line"><span class="keyword">this</span>._candyGroup = <span class="keyword">this</span>.add.group();</div><div class="line">Candy.item.spawnCandy(<span class="keyword">this</span>);</div><div class="line">&#125;,</div></pre></td></tr></table></figure><p></p><p>create() 函数开始之前，我们建立了ARCADE 物理系统—-Phaser中有现成的，这是最简单的一种。之后，我们添加了重力。然后我们添加三个图片：背景，怪物，得分UI。第四个增加的元素是暂停按钮，注意我们使用的是 candy.game_width和 candy.game_height 变量，定义在 Candy.Preloader() 。</p><p>然后我们创建怪物，玩家的虚拟形象。这是一个动画精灵。看起来像是站着在呼吸。</p><p>animations.add()</p><p>函数创建帧动画，需要四个参数：</p><ul><li>· 动画的名称（可以参考它以后）</li><li>· 包含所有帧的table（我们可以只使用其中一些）</li><li>· 帧速</li><li>· 一个决定动画是否循环的标签</li></ul><p>我们使用 animations.play() 播放动画。 我们将 spawncandytimer 设为0 ；的怪物生命 health设为10。</p><h3 id="文本格式"><a href="#文本格式" class="headerlink" title="文本格式"></a><strong>文本格式</strong></h3><p>接下来的两行代码，可以让我们在屏幕上显示文字。this.add.text()函数有四个参数：屏幕左侧和顶部的绝对位置，实际的文本字符串和配置对象。</p><p>我们可以使用CSS那样设置文本格式。 代码如下：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>._fontStyle = &#123;</div><div class="line">font: <span class="string">"40px Arial"</span>,</div><div class="line">fill: <span class="string">"#FFCC00"</span>,</div><div class="line">stroke: <span class="string">"#333"</span>,</div><div class="line">strokeThickness: <span class="number">5</span>,</div><div class="line">align: <span class="string">"center"</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p><p>字体是Arial，40像素高，黄色，可以设置描边（颜色和厚度），文本中心对齐。</p><p>之后，我们定义 candygroup 和第一颗糖果。</p><h3 id="暂停游戏"><a href="#暂停游戏" class="headerlink" title="暂停游戏"></a><strong>暂停游戏</strong></h3><p>暂停功能看起来像这样：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">managePause: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.game.paused = <span class="literal">true</span>;</div><div class="line"><span class="keyword">var</span> pausedText = <span class="keyword">this</span>.add.text(<span class="number">100</span>, <span class="number">250</span>, <span class="string">"Game paused.\nTap anywhere to continue."</span>, <span class="keyword">this</span>._fontStyle);</div><div class="line"><span class="keyword">this</span>.input.onDown.add(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">pausedText.destroy();</div><div class="line"><span class="keyword">this</span>.game.paused = <span class="literal">false</span>;</div><div class="line">&#125;, <span class="keyword">this</span>);</div><div class="line">&#125;,</div></pre></td></tr></table></figure><p></p><p>每次暂停按钮被点击时，我们改变this.game.paused状态为 true ，显示相应的提示给玩家，并为玩家单击或点击屏幕的行为建立一个事件侦听器。当单击或点击被检测到，我们删除文本并设 this.game.paused 为 false 。</p><p>paused 变量在 game 对象中是特殊的，因为它将暂停游戏中所有动画以及计算，所以一切都被冻结，直到我们取消暂停，游戏暂停状态被设置为false。</p><h3 id="更新循环"><a href="#更新循环" class="headerlink" title="更新循环"></a><strong>更新循环</strong></h3><p>update() 函数Phaser保留的函数之一。当你用这个名字命名一个函数，它将在游戏的每一帧被执行。<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">update: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>._spawnCandyTimer += <span class="keyword">this</span>.time.elapsed;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">this</span>._spawnCandyTimer &gt; <span class="number">1000</span>) &#123;</div><div class="line"><span class="keyword">this</span>._spawnCandyTimer = <span class="number">0</span>;</div><div class="line">Candy.item.spawnCandy(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">this</span>._candyGroup.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">candy</span>)</span>&#123;</div><div class="line">candy.angle += candy.rotateMe;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">if</span>(!Candy._health) &#123;</div><div class="line"><span class="keyword">this</span>.add.sprite((Candy.GAME_WIDTH<span class="number">-594</span>)/<span class="number">2</span>, (Candy.GAME_HEIGHT<span class="number">-271</span>)/<span class="number">2</span>, <span class="string">'game-over'</span>);</div><div class="line"><span class="keyword">this</span>.game.paused = <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>我们用spawncandytimer 变量来跟踪时间。if 语句每秒检查一次，在游戏世界中释放一个新糖果后时间是否被重置，（也就是说，对于spawncandytimer是 1000毫秒）。然后，我们用forEach遍历所有糖果对象内的糖果集团（我们可以有一个以上的屏幕上使用 ），增加固定的数值到糖果的angle变量（存储在糖果对象中的rotateMe），使他们以固定的速度下落。我们做的最后一件事是检查 health 是否 下降到0，如果这样的话，那么我们在屏幕上显示游戏结束并暂停游戏。</p><h3 id="糖果事件管理"><a href="#糖果事件管理" class="headerlink" title="糖果事件管理"></a><strong>糖果事件管理</strong></h3><p>我们使用item定义糖果，包含的函数有： spawncandy() ，clickcandy() 和 removecandy()。为了方便使用在 Game保留一些糖果的变量。<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">spawnCandy: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">var</span> dropPos = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*Candy.GAME_WIDTH);</div><div class="line"><span class="keyword">var</span> dropOffset = [<span class="number">-27</span>,<span class="number">-36</span>,<span class="number">-36</span>,<span class="number">-38</span>,<span class="number">-48</span>];</div><div class="line"><span class="keyword">var</span> candyType = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">5</span>);</div><div class="line"><span class="keyword">var</span> candy = game.add.sprite(dropPos, dropOffset[candyType], <span class="string">'candy'</span>);</div><div class="line">candy.animations.add(<span class="string">'anim'</span>, [candyType], <span class="number">10</span>, <span class="literal">true</span>);</div><div class="line"></div><div class="line">game.physics.enable(candy, Phaser.Physics.ARCADE);</div><div class="line">candy.inputEnabled = <span class="literal">true</span>;</div><div class="line">candy.events.onInputDown.add(<span class="keyword">this</span>.clickCandy, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">candy.checkWorldBounds = <span class="literal">true</span>;</div><div class="line">candy.events.onOutOfBounds.add(<span class="keyword">this</span>.removeCandy, <span class="keyword">this</span>);</div><div class="line">candy.anchor.setTo(<span class="number">0.5</span>, <span class="number">0.5</span>);</div><div class="line">candy.rotateMe = (<span class="built_in">Math</span>.random()*<span class="number">4</span>)<span class="number">-2</span>;</div><div class="line">game._candyGroup.add(candy);</div><div class="line">&#125;,</div></pre></td></tr></table></figure><p></p><p>函数首先定义三个值：</p><ul><li>· 糖果随机下落x坐标（数值在0和游戏画面宽度之间）</li><li>· 糖果随机下落y坐标，基于糖果自身的高度</li><li>· 随机的糖果类型（糖果一共有五个不同的图像）</li></ul><p>然后我们添加一个糖果作为精灵，其起始位置和图像根据上面的定义。我们还需要为糖果旋转设定动画帧。</p><p>接下来我们用物理引擎使糖果自然地从屏幕顶部坠落。然后，我们使糖果对点击产生回应，加入事件监听器。</p><p>为确保糖果离开游戏屏幕时被销毁，我们将checkWorldBounds 设为true。糖果离开屏幕时，函数events.onOutOfBounds()将被调用；我们用它调用removecandy() 函数。设置锚点在糖果上，使其绕轴线旋转。在这里我们设置了 rotateMe 变量，在update()循环中转动糖果；我们选择 -2和 +2之间的一个值。最后一行代码将新创建的糖果加入到糖果群组，这样我们就可以不停的循环他们 。</p><p>我们来讲下一个函数， clickcandy()：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">clickCandy: <span class="function"><span class="keyword">function</span>(<span class="params">candy</span>) </span>&#123;</div><div class="line">candy.kill();</div><div class="line">Candy._score += <span class="number">1</span>;</div><div class="line">Candy._scoreText.setText(Candy._score);</div><div class="line">&#125;,</div></pre></td></tr></table></figure><p></p><p>这里需要将一个糖果作为参数，采用Phaser自带的方法 kill() 删除它。我们还增加了得分1，并更新得分的文本。</p><p>重置糖果也同样容易和简单：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">removeCandy: <span class="function"><span class="keyword">function</span>(<span class="params">candy</span>) </span>&#123;</div><div class="line">candy.kill();</div><div class="line">Candy._health -= <span class="number">10</span>;</div><div class="line">&#125;,</div></pre></td></tr></table></figure><p></p><p>当糖果被点击或掉出屏幕。removecandy() 函数会被调用。candy对象会被删除，玩家失去10点生命。（游戏一开始玩家有10点生命，所以有一个糖果掉出屏幕游戏就结束了）</p><h3 id="原型和游戏状态"><a href="#原型和游戏状态" class="headerlink" title="原型和游戏状态"></a><strong>原型和游戏状态</strong></h3><p>我们已经了解了游戏机制，核心理念，以及游戏玩法。现在是时候去看代码的其他部分了：加载屏幕，加载资源，管理按钮点击等等。</p><p>我们已经知道了游戏状态，让我们一个接一个看看他们：</p><h3 id="Boot-js"><a href="#Boot-js" class="headerlink" title="Boot.js"></a><strong>Boot.js</strong></h3><p>boot.js 是JavaScript文件，我们将定义主要游戏对象Candy（你可以取个你喜欢的名字）。这里boot.js 文件的源代码：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Candy = &#123;&#125;;</div><div class="line">Candy.Boot = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;&#125;;</div><div class="line">Candy.Boot.prototype = &#123;</div><div class="line">preload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'preloaderBar'</span>, <span class="string">'img/loading-bar.png'</span>);</div><div class="line">&#125;,</div><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.input.maxPointers = <span class="number">1</span>;</div><div class="line"><span class="keyword">this</span>.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;</div><div class="line"><span class="keyword">this</span>.scale.pageAlignHorizontally = <span class="literal">true</span>;</div><div class="line"><span class="keyword">this</span>.scale.pageAlignVertically = <span class="literal">true</span>;</div><div class="line"><span class="keyword">this</span>.scale.setScreenSize(<span class="literal">true</span>);</div><div class="line"><span class="keyword">this</span>.state.start(<span class="string">'Preloader'</span>);</div><div class="line">&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p><p>正如你所看到的，我们从 var Candy = {} 开始，为游戏创建了一个全局对象。</p><p>Candy.Boot = function(game){} 代码创建一个新函数称为 boot() （index.html 有调用）将game 对象作为参数（index.html也被创建 ）。</p><p>Candy.Boot.prototype = {} 代码是使用原型定义Candy.Boot 内容的一种方式。<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Candy.Boot.prototype = &#123;</div><div class="line">preload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="comment">// code</span></div><div class="line">&#125;,</div><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="comment">// code</span></div><div class="line">&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p><p>Phaser有一些保留的函数名称，正如我之前提到 ；preload() 和 create() 就是其中的两个。 preload() 用于加载所有资源； create() 只调用一次（在 preload()之后），所以你可以把代码当对象一样安排，就像定义变量或添加精灵。</p><p>我们的Boot对象包含这两个函数，这样他们就可以被Candy.Boot.preload()和Candy.Boot.create()调用。正如你所看到 boot.js 文件的完整的源代码，preload() 函数加载了一个图像到框架中：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">preload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'preloaderBar'</span>, <span class="string">'img/loading-bar.png'</span>);</div><div class="line">[size=<span class="number">14</span>px]&#125;,</div></pre></td></tr></table></figure><p></p><p>this.load.image()中第一个参数是我们给图像取的名字，第二个是图像文件的路径。</p><p>为什么我们要在 boot.js 文件中加载图像，用preload.js 不行吗？好吧，因为我们需要一个加载条来显示所有资源（preload.js）的加载状态， 因此它需要第一个被加载。</p><h3 id="缩放选项"><a href="#缩放选项" class="headerlink" title="缩放选项"></a><strong>缩放选项</strong></h3><p>create() 函数包含了一些Phaser特定的输入和缩放设置：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.input.maxPointers = <span class="number">1</span>;</div><div class="line"><span class="keyword">this</span>.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;</div><div class="line"><span class="keyword">this</span>.scale.pageAlignHorizontally = <span class="literal">true</span>;</div><div class="line"><span class="keyword">this</span>.scale.pageAlignVertically = <span class="literal">true</span>;</div><div class="line"><span class="keyword">this</span>.scale.setScreenSize(<span class="literal">true</span>);</div><div class="line"><span class="keyword">this</span>.state.start(<span class="string">'Preloader'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>第一行，input.maxpointers 设为1，我们的游戏不需要多点触摸。</p><p>scale.scalemode 控制游戏的旋转。可用的设置有： exact_fit ，no_scale 和 show_all你可以枚举他们，使用数值0，1，或2。exact_fit，将最大化游戏；no_scale将禁用缩放；show_all将确保游戏符合给定的尺寸，一切都会显示在屏幕上（按比例缩放 ）。</p><p>将 scale.pagealignhorizontally 和 scale.pagealignvertically 设为 true ，将使游戏在水平和垂直方向居中。</p><p>调用 scale.setScreenSize(true) “激活”缩放。</p><p>最后一行， state.start(‘Preloader’)，执行下一个Preloader 状态</p><h3 id="Preloader-js"><a href="#Preloader-js" class="headerlink" title="Preloader.js"></a><strong>Preloader.js</strong></h3><p>与preload()函数相比，create() 函数非常简单，因为 create() 函数只需要负责切换状态。</p><p>preloader.js 源代码：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Candy.Preloader = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>)</span>&#123;</div><div class="line">Candy.GAME_WIDTH = <span class="number">640</span>;</div><div class="line">Candy.GAME_HEIGHT = <span class="number">960</span>;</div><div class="line">&#125;;</div><div class="line">Candy.Preloader.prototype = &#123;</div><div class="line">preload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.stage.backgroundColor = <span class="string">'#B4D9E7'</span>;</div><div class="line"><span class="keyword">this</span>.preloadBar = <span class="keyword">this</span>.add.sprite((Candy.GAME_WIDTH<span class="number">-311</span>)/<span class="number">2</span>,</div><div class="line">(Candy.GAME_HEIGHT<span class="number">-27</span>)/<span class="number">2</span>, <span class="string">'preloaderBar'</span>);</div><div class="line"><span class="keyword">this</span>.load.setPreloadSprite(<span class="keyword">this</span>.preloadBar);</div><div class="line"></div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'background'</span>, <span class="string">'img/background.png'</span>);</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'floor'</span>, <span class="string">'img/floor.png'</span>);</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'monster-cover'</span>, <span class="string">'img/monster-cover.png'</span>);</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'title'</span>, <span class="string">'img/title.png'</span>);</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'game-over'</span>, <span class="string">'img/gameover.png'</span>);</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'score-bg'</span>, <span class="string">'img/score-bg.png'</span>);</div><div class="line"><span class="keyword">this</span>.load.image(<span class="string">'button-pause'</span>, <span class="string">'img/button-pause.png'</span>);</div><div class="line"></div><div class="line"><span class="keyword">this</span>.load.spritesheet(<span class="string">'candy'</span>, <span class="string">'img/candy.png'</span>, <span class="number">82</span>, <span class="number">98</span>);</div><div class="line"><span class="keyword">this</span>.load.spritesheet(<span class="string">'monster-idle'</span>,</div><div class="line"><span class="string">'img/monster-idle.png'</span>, <span class="number">103</span>, <span class="number">131</span>);</div><div class="line"><span class="keyword">this</span>.load.spritesheet(<span class="string">'button-start'</span>,</div><div class="line"><span class="string">'img/button-start.png'</span>, <span class="number">401</span>, <span class="number">143</span>);</div><div class="line">&#125;,</div><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.state.start(<span class="string">'MainMenu'</span>);</div><div class="line">&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p><p>与 boot.js 比较像；定义 Preloader 对象和两个原型函数（preload() 和 create()）。</p><p>Prototype 对象，我们定义了两个变量： candy.game_width 和 candy.game_height；它们设置游戏屏幕默认的宽度和高度。</p><p>preload() 的前3行代码设置舞台的背景颜色（ # b4d9e7，浅蓝色），显示游戏中的精灵，setPreloadSprite() 函数将负责资源的加载。 我们来看add.sprite() 函数：</p><p>this.preloadBar = this.add.sprite((640-311)/2, (960-27)/2, ‘preloaderBar’);</p><p>正如你所看到的，我们需要三个值：图像x轴绝对坐标（舞台宽度减去图像宽度再除以2），图像y轴绝对坐标（类似计算）以及图像的名称（我们已经在 boot.js 文件中加载）。</p><h3 id="加载spritesheets"><a href="#加载spritesheets" class="headerlink" title="加载spritesheets"></a><strong>加载spritesheets</strong></h3><p>接下来的几行是使用 load.image() （你已经看到了）加载所有的图形资源。</p><p>最后3行代码有点不同：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.load.spritesheet(<span class="string">'candy'</span>, <span class="string">'img/candy.png'</span>, <span class="number">82</span>, <span class="number">98</span>);</div></pre></td></tr></table></figure><p></p><p>load.spritesheet()函数，不是加载单一的图片，而是spritesheet。两个额外的参数告诉函数单个图像的尺寸。</p><p><img src="http://www.npm8.com/wp-content/uploads/2015/08/34.png" alt="3"></p><p>在这里candy.png我们有5种不同类型的糖果。图片尺寸410x98px，但是单一元素的大小是82x98px，在load.spritesheet()函数中定义。玩家spritesheet以同样的方式加载。</p><p>create()函数开始游戏的下一个状态MainMenu，当所有资源加载完毕就会显示游戏菜单。</p><h3 id="MainMenu-js"><a href="#MainMenu-js" class="headerlink" title="MainMenu.js"></a><strong>MainMenu.js</strong></h3><p>在这里渲染图片，添加按钮以及游戏循环。<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Candy.MainMenu = <span class="function"><span class="keyword">function</span>(<span class="params">game</span>) </span>&#123;&#125;;</div><div class="line">Candy.MainMenu.prototype = &#123;</div><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.add.sprite(<span class="number">0</span>, <span class="number">0</span>, <span class="string">'background'</span>);</div><div class="line"><span class="keyword">this</span>.add.sprite(<span class="number">-130</span>, Candy.GAME_HEIGHT<span class="number">-514</span>, <span class="string">'monster-cover'</span>);</div><div class="line"><span class="keyword">this</span>.add.sprite((Candy.GAME_WIDTH<span class="number">-395</span>)/<span class="number">2</span>, <span class="number">60</span>, <span class="string">'title'</span>);</div><div class="line"><span class="keyword">this</span>.add.button(Candy.GAME_WIDTH<span class="number">-401</span><span class="number">-10</span>, Candy.GAME_HEIGHT<span class="number">-143</span><span class="number">-10</span>,</div><div class="line"><span class="string">'button-start'</span>, <span class="keyword">this</span>.startGame, <span class="keyword">this</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</div><div class="line">&#125;,</div><div class="line">startGame: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.state.start(<span class="string">'Game'</span>);</div><div class="line">&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p></p><p>MainMenu没有preload()函数，因为资源已在Preload.js加载。</p><p>这里有2个函数，create()，startGame()。 先看 startGame() 函数:<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">startGame: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.state.start(<span class="string">'Game'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>这个函数只负责开始游戏循环，但是它不会自动执行，我们需要通过按钮来触发它。<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">create: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"><span class="keyword">this</span>.add.sprite(<span class="number">0</span>, <span class="number">0</span>, <span class="string">'background'</span>);</div><div class="line"><span class="keyword">this</span>.add.sprite(<span class="number">-130</span>, Candy.GAME_HEIGHT<span class="number">-514</span>, <span class="string">'monster-cover'</span>);</div><div class="line"><span class="keyword">this</span>.add.sprite((Candy.GAME_WIDTH<span class="number">-395</span>)/<span class="number">2</span>, <span class="number">60</span>, <span class="string">'title'</span>);</div><div class="line"><span class="keyword">this</span>.add.button(Candy.GAME_WIDTH<span class="number">-401</span><span class="number">-10</span>, Candy.GAME_HEIGHT<span class="number">-143</span><span class="number">-10</span>,</div><div class="line"><span class="string">'button-start'</span>, <span class="keyword">this</span>.startGame, <span class="keyword">this</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</div><div class="line">&#125;,</div></pre></td></tr></table></figure><p></p><p>create()有3个add.sprite()函数，它们加载图片到舞台上。我们的主菜单在背景上，小怪物在角落里，还有游戏的标题。</p><h3 id="按钮"><a href="#按钮" class="headerlink" title="按钮"></a><strong>按钮</strong></h3><p>还有一个我们早已在Game 状态使用的对象，就是按钮：<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.startButton = <span class="keyword">this</span>.add.button(Candy.GAME_WIDTH<span class="number">-401</span><span class="number">-10</span>, Candy.GAME_HEIGHT<span class="number">-143</span><span class="number">-10</span>,<span class="string">'button-start'</span>, <span class="keyword">this</span>.startGame, <span class="keyword">this</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</div></pre></td></tr></table></figure><p></p><p>这个按钮看起来比我们之前的代码都要复杂。我们通过八种不同的参数创建按钮：x轴位置，y轴位置，图像的名称（或精灵），单击该按钮时执行的函数，该函数执行环境，指定按钮使用的图片。</p><p>这是按钮的spritesheet，包含状态标签：</p><p><img src="http://www.npm8.com/wp-content/uploads/2015/08/button-start-150x150.png" alt="button-start"></p><p>与candy.png非常相似，垂直排列。</p><p>记住最后三位数字传递给函数的意义—1 0 2-它们分别代表按钮的不同状态：over（鼠标悬停），out（正常），和down（触摸或点击）。在 button.png我们有不同的图片代表他们。</p><p>现在你已经了解了Phaser游戏框架的基础。恭喜你！</p><h3 id="游戏成品"><a href="#游戏成品" class="headerlink" title="游戏成品"></a><strong>游戏成品</strong></h3><p>本文中使用的demo游戏已经演变成一个<a href="http://enclavegames.com/games/monster-wants-candy/" target="_blank" rel="external">完整的游戏</a> ， 你可以<a href="http://candy.enclavegames.com/" target="_blank" rel="external">在这里玩</a>。你看，有生命，成就，得分，和其他有趣的功能，他们中的大多数都基于你已经学到的知识。</p><p>&nbsp;</p><p><img src="http://www.npm8.com/wp-content/uploads/2015/08/11.jpg" alt="11"></p><p>你还可以阅读 <a href="http://enclavegames.com/blog/2014/06/02/monster-wants-candy-the-making-of/" target="_blank" rel="external">这一篇记录</a> ，了解游戏起源以及游戏背后的故事，还有一些有趣的事实。</p><h3 id="资源"><a href="#资源" class="headerlink" title="资源"></a><strong>资源</strong></h3><p>在过去的几个月里，为移动设备开发HTML5游戏已经非常流行了。该技术将越来越好，几乎每天都有新的工具和服务出现，现在是进入潜在市场的最佳时机。</p><p>类似Phaser这样的引擎给了你开发适配各种不同手机设备游戏的能力。多亏了HTML5，你的目标不再仅仅是移动平台和桌面浏览器，还将包括其他不同的操作系统和原生平台。</p><p>现在有很多资源可以帮助你进入HTML5游戏开发，例如 <a href="http://html5devstarter.enclavegames.com/" target="_blank" rel="external">HTML5游戏开发新手教程</a> 列表或者 <a href="https://hacks.mozilla.org/2013/09/getting-started-with-html5-game-development/" target="_blank" rel="external">开始用HTML5开发游戏</a> 。如果你需要任何帮助，可以在<a href="http://www.html5gamedevs.com/" target="_blank" rel="external">html5gamedevs</a> 论坛寻求帮助或直接在 freenode IRC的<a href="http://webchat.freenode.net/?channels=bbg" target="_blank" rel="external"># BBG通道</a>上提问。你还可以关注即将发布的新书<a href="http://firefoxos.enclavegames.com/" target="_blank" rel="external">Firefox OS and HTML5 games</a>。甚至还有一个<a href="http://gamedevjsweekly.com/" target="_blank" rel="external">Gamedev.js Weekly</a> 通邮件列表你可以订阅。</p><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a><strong>概要</strong></h3><p>这是一段关于<a href="http://candy-demo.enclavegames.com/" target="_blank" rel="external">怪物要糖果demo</a>代码的漫长旅程，我希望能帮助你学习Phaser，在不久的将来你可以开发很酷的游戏。</p></div><div><div style="padding:10px 0;margin:20px auto;width:94%;text-align:center"><div></div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>打赏一个泡泡糖</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/uploads/wechatpay.jpg" alt="baosheng WeChat Pay"><p>微信</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/uploads/alipay.jpg" alt="baosheng Alipay"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/phaser-怪物要糖果demo/" rel="tag"># phaser 怪物要糖果demo</a> <a href="/tags/phaser教程/" rel="tag"># phaser教程</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2015/08/29/javascript-面向对象继承详解/" rel="next" title="javascript 面向对象继承详解"><i class="fa fa-chevron-left"></i> javascript 面向对象继承详解</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2015/08/29/深入分析详解phaser状态管理statemanager/" rel="prev" title="深入分析详解Phaser状态管理(StateManager)">深入分析详解Phaser状态管理(StateManager) <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zMDA4OC82NjQz"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="baosheng"><p class="site-author-name" itemprop="name">baosheng</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">511</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">9</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">800</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://www.npm8.com/" title="申请友情链接加QQ：347675731" target="_blank">申请友情链接加QQ：347675731</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#说明"><span class="nav-number">1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phaser是什么？"><span class="nav-number">2.</span> <span class="nav-text">Phaser是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是怪物要糖果？"><span class="nav-number">3.</span> <span class="nav-text">什么是怪物要糖果？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目设置及结构"><span class="nav-number">4.</span> <span class="nav-text">项目设置及结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#游戏"><span class="nav-number">5.</span> <span class="nav-text">游戏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Portrait-模式"><span class="nav-number">6.</span> <span class="nav-text">Portrait 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Game-js"><span class="nav-number">7.</span> <span class="nav-text">Game.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文本格式"><span class="nav-number">8.</span> <span class="nav-text">文本格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#暂停游戏"><span class="nav-number">9.</span> <span class="nav-text">暂停游戏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新循环"><span class="nav-number">10.</span> <span class="nav-text">更新循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#糖果事件管理"><span class="nav-number">11.</span> <span class="nav-text">糖果事件管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原型和游戏状态"><span class="nav-number">12.</span> <span class="nav-text">原型和游戏状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Boot-js"><span class="nav-number">13.</span> <span class="nav-text">Boot.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缩放选项"><span class="nav-number">14.</span> <span class="nav-text">缩放选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Preloader-js"><span class="nav-number">15.</span> <span class="nav-text">Preloader.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载spritesheets"><span class="nav-number">16.</span> <span class="nav-text">加载spritesheets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MainMenu-js"><span class="nav-number">17.</span> <span class="nav-text">MainMenu.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#按钮"><span class="nav-number">18.</span> <span class="nav-text">按钮</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#游戏成品"><span class="nav-number">19.</span> <span class="nav-text">游戏成品</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#资源"><span class="nav-number">20.</span> <span class="nav-text">资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#概要"><span class="nav-number">21.</span> <span class="nav-text">概要</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2014 - <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">baosheng</span><script language="javascript" type="text/javascript" src="//js.users.51.la/19323703.js"></script><noscript><a href="//www.51.la/?19323703" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="//img.users.51.la/19323703.asp" style="border:none"></a></noscript></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></body></html><!-- rebuild by neat -->